import{y as s}from"./index-C4myuZdd.js";async function u(){const{data:{session:i}}=await s.auth.getSession();if(!i)throw new Error("Not authenticated");return i.access_token}async function l(){const{data:{session:i}}=await s.auth.getSession();if(!i)throw new Error("Not authenticated");return i.user.id}class p{static async discover(e,t={}){try{const a=await u();switch(e){case"scooter":return await this.discoverScooters(t);case"carpool":return await this.discoverTrips(t);case"package":return await this.discoverCaptains(t);case"school":return await this.discoverSchoolRoutes(t);default:return await this.discoverTrips(t)}}catch(a){return{success:!1,error:a.message}}}static async discoverScooters(e){const{data:t,error:a}=await s.rpc("get_nearby_scooters",{user_lat:e.lat||25.2048,user_lng:e.lng||55.2708,radius_km:e.radius||2});if(a){console.warn("RPC get_nearby_scooters failed, falling back to basic query:",a);const{data:r,error:c}=await s.from("scooters").select("*").eq("status","available").gte("battery",e.minBattery||20);if(c)throw c;return{success:!0,data:r}}return{success:!0,data:t}}static async discoverTrips(e){let t=s.from("trips").select(`
        *,
        driver:driver_id(id, full_name, phone_number, rating)
      `).eq("status","active").gte("available_seats",e.seats||1);e.from&&(t=t.ilike("from_location",`%${e.from}%`)),e.to&&(t=t.ilike("to_location",`%${e.to}%`)),e.date&&(t=t.eq("departure_date",e.date)),e.isFemaleOnly!==void 0&&(t=t.eq("is_female_only",e.isFemaleOnly));const{data:a,error:r}=await t;if(r)throw r;return{success:!0,data:a}}static async discoverCaptains(e){const{data:t,error:a}=await s.from("trips").select(`
        *,
        driver:driver_id(id, full_name, phone_number, rating)
      `).eq("status","active").ilike("from_location",`%${e.from}%`).ilike("to_location",`%${e.to}%`);if(a)throw a;return{success:!0,data:t}}static async discoverSchoolRoutes(e){const{data:t,error:a}=await s.from("school_routes").select("*").eq("status","active");if(a)throw a;return{success:!0,data:t}}static async request(e){try{const t=await l();switch(e.type){case"scooter":return await this.requestScooter(t,e.details);case"carpool":return await this.requestTrip(t,e);case"package":return await this.requestPackageDelivery(t,e);case"school":return await this.requestSchoolTransport(t,e);default:return await this.requestTrip(t,e)}}catch(t){return{success:!1,error:t.message}}}static async requestScooter(e,t){const{data:a,error:r}=await s.from("scooter_rentals").insert({user_id:e,scooter_id:t.scooterId,start_time:new Date().toISOString(),status:"pending"}).select().single();if(r)throw r;return{success:!0,data:a}}static async requestTrip(e,t){const{data:a,error:r}=await s.from("trips").insert({driver_id:e,from_location:t.from?.address||"",to_location:t.to?.address||"",departure_date:t.date,departure_time:t.time,...t.details}).select().single();if(r)throw r;return{success:!0,data:a}}static async requestPackageDelivery(e,t){const{data:a,error:r}=await s.from("package_deliveries").insert({sender_id:e,from_location:`POINT(${t.from?.lng} ${t.from?.lat})`,to_location:`POINT(${t.to?.lng} ${t.to?.lat})`,...t.details,tracking_code:this.generateTrackingCode(),status:"pending"}).select().single();if(r)throw r;return{success:!0,data:a}}static async requestSchoolTransport(e,t){const{data:a,error:r}=await s.from("school_routes").insert({created_by:e,...t.details,status:"active"}).select().single();if(r)throw r;return{success:!0,data:a}}static async calculatePrice(e,t){try{switch(e){case"scooter":return this.calculateScooterPrice(t);case"package":return this.calculatePackagePrice(t);case"carpool":return this.calculateTripPrice(t);case"school":return this.calculateSchoolTransportPrice(t);default:return this.calculateTripPrice(t)}}catch(a){return{success:!1,error:a.message}}}static calculateScooterPrice(e){const t=e.durationMinutes||30,a=e.pricePerMin||1,r=5,c=r+t*a;return{success:!0,data:{basePrice:r,perMinutePrice:a,estimatedDuration:t,totalPrice:parseFloat(c.toFixed(2))}}}static calculatePackagePrice(e){const{packageSize:t,distanceKm:a}=e,r={small:15,medium:35,large:60},c=r[t]||35,o=(a||10)*2,n=c+o;return{success:!0,data:{basePrice:c,distancePrice:o,totalPrice:parseFloat(n.toFixed(2)),breakdown:{packageSize:r[t],distance:o}}}}static calculateTripPrice(e){const{distanceKm:t,seats:a}=e,o=10+t*2,n=o/(a||1);return{success:!0,data:{totalPrice:parseFloat(o.toFixed(2)),pricePerSeat:parseFloat(n.toFixed(2)),distanceKm:t,seats:a||1}}}static calculateSchoolTransportPrice(e){const{students:t,days:a}=e,r=25,c=t*a.length*r*4;return{success:!0,data:{perStudentPerDay:r,monthlyTotal:c,students:t,activeDays:a.length}}}static async assign(e,t,a){try{switch(e){case"scooter":return await this.assignScooter(t);case"package":return await this.assignCaptain(t,a);case"carpool":return await this.assignDriver(t,a);default:return{success:!0,data:{assigned:!0}}}}catch(r){return{success:!1,error:r.message}}}static async assignScooter(e){const{data:t,error:a}=await s.from("scooter_rentals").update({status:"assigned"}).eq("id",e).select().single();if(a)throw a;return{success:!0,data:t}}static async assignCaptain(e,t){const{data:a,error:r}=await s.from("package_deliveries").update({captain_id:t,status:"assigned"}).eq("id",e).select().single();if(r)throw r;return{success:!0,data:a}}static async assignDriver(e,t){const{data:a,error:r}=await s.from("bookings").update({status:"accepted"}).eq("id",e).select().single();if(r)throw r;return{success:!0,data:a}}static async confirm(e,t,a){try{const r=this.getTableName(e),{data:c,error:o}=await s.from(r).update({status:"confirmed",confirmed_at:new Date().toISOString(),payment_status:"completed"}).eq("id",t).select().single();if(o)throw o;return{success:!0,data:c}}catch(r){return{success:!1,error:r.message}}}static async start(e,t){try{const a=this.getTableName(e),r=e==="scooter"?"start_time":"started_at",{data:c,error:o}=await s.from(a).update({status:"active",[r]:new Date().toISOString()}).eq("id",t).select().single();if(o)throw o;return{success:!0,data:c}}catch(a){return{success:!1,error:a.message}}}static async complete(e,t,a){try{const r=this.getTableName(e),c=e==="scooter"?"end_time":"completed_at",{data:o,error:n}=await s.from(r).update({status:"completed",[c]:new Date().toISOString(),...a}).eq("id",t).select().single();if(n)throw n;return{success:!0,data:o}}catch(r){return{success:!1,error:r.message}}}static getTableName(e){return{carpool:"trips",scooter:"scooter_rentals",package:"package_deliveries",school:"school_routes",medical:"trips",pet:"trips",luxury:"trips",freight:"trips","car-rental":"car_rentals",shuttle:"trips",hospitality:"trips"}[e]||"trips"}static generateTrackingCode(){return"WAS"+Date.now().toString(36).toUpperCase()+Math.random().toString(36).substring(2,7).toUpperCase()}static async getUserServices(e,t){try{if(t){const a=this.getTableName(t),{data:r,error:c}=await s.from(a).select("*").or(`created_by.eq.${e},user_id.eq.${e},sender_id.eq.${e},driver_id.eq.${e}`);if(c)throw c;return{success:!0,data:r}}else{const[a,r,c,o]=await Promise.all([s.from("trips").select("*").or(`driver_id.eq.${e},passenger_id.eq.${e}`),s.from("scooter_rentals").select("*").eq("user_id",e),s.from("package_deliveries").select("*").eq("sender_id",e),s.from("school_routes").select("*").eq("created_by",e)]);return{success:!0,data:{trips:a.data||[],scooters:r.data||[],packages:c.data||[],schools:o.data||[]}}}}catch(a){return{success:!1,error:a.message}}}}export{p as S};
