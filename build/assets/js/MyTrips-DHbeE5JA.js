import{r,j as e}from"./vendor-ui-S1-b02vM.js";import{t as M,A as X,m as A,C as u,f as g,h as N,B as x,u as Z,j as q}from"./index-C4myuZdd.js";import{T as ee,a as se,b as E,c as U}from"./tabs-B9Xs08FN.js";import{D as ae,a as te,b as re,c as le}from"./dialog-y1zr9Dfl.js";import{A as ie,a as ne}from"./avatar-BeTgQo5q.js";import{M as ce,N as de,u as oe}from"./useTrips-BBJaC5In.js";import{C as me}from"./clock-DfBHxk1w.js";import{C as F}from"./car-B3BmIsNb.js";import{U as xe}from"./users-BYsldg1t.js";import{M as he}from"./map-pin-Df2cP3Jg.js";import{S as pe}from"./share-2-BUjfaAF9.js";import{P as ue}from"./phone-ag23RKTP.js";import{T as ge}from"./triangle-alert-Dx7rqs8N.js";import{u as je}from"./useBookings-DDDAlem2.js";import{L as B}from"./locate-vTgYpdHc.js";import{M as I}from"./move-right-xBcSULm3.js";import{U as fe}from"./users-round-6idvwZaa.js";import{R as Ne}from"./radar-BFej6-JE.js";import"./vendor-react-7PqXWhc5.js";import"./vendor-utils-Drrw94dm.js";import"./vendor-supabase-DCWnlmhc.js";import"./vendor-animation-BozBRtxF.js";import"./serviceFactory-BhemUNoC.js";function ve({tripId:n,route:l,isDriver:t=!1,allowLocationSharing:w=!0,onShareLocation:j,onEmergency:m}){const[c,p]=r.useState(null),[f,T]=r.useState(null),[v,S]=r.useState(null),[_,L]=r.useState(null),[R,z]=r.useState(0),[y,a]=r.useState(0),[d,b]=r.useState(!1),[D,s]=r.useState(0),[k,$]=r.useState(!0),h=r.useRef(null),C=r.useRef(Date.now());r.useEffect(()=>("geolocation"in navigator&&(h.current=navigator.geolocation.watchPosition(i=>{const o={lat:i.coords.latitude,lng:i.coords.longitude};p(o),i.coords.speed!==null&&a(Math.round(i.coords.speed*3.6)),d&&j&&j(o),t?T(o):S(o),C.current=Date.now()},i=>{console.error("Location tracking error:",i),M.error("Unable to track location. Please enable GPS.")},{enableHighAccuracy:!0,maximumAge:1e3,timeout:5e3})),()=>{h.current!==null&&navigator.geolocation.clearWatch(h.current)}),[d,t,j]),r.useEffect(()=>{if(!c||l.length===0)return;const i=l[l.length-1],o=W(c.lat,c.lng,i.lat,i.lng);z(o);const J=y>0?y:40,K=o/J*60;if(L(Math.round(K)),l.length>1){const O=ye(l),Q=Math.min(100,Math.max(0,(O-o)/O*100));s(Q)}},[c,l,y]);const H=()=>{b(!d),M.success(d?"Location sharing stopped":"Location sharing started")},V=()=>{m&&m(),M.error("Emergency alert sent to contacts and authorities")},Y=()=>{if(c){const i=`https://maps.google.com/?q=${c.lat},${c.lng}`;navigator.share?navigator.share({title:"My Current Location",text:"Track my location in real-time",url:i}):(navigator.clipboard.writeText(i),M.success("Location link copied to clipboard"))}},G=[...l.map((i,o)=>({lat:i.lat,lng:i.lng,label:i.label||`Stop ${o+1}`,type:o===0?"start":o===l.length-1?"destination":"stop"})),...f?[{lat:f.lat,lng:f.lng,label:"Driver",type:"driver"}]:[],...v&&!t?[{lat:v.lat,lng:v.lng,label:"You",type:"user"}]:[]];return e.jsxs("div",{className:"relative h-full flex flex-col",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(ce,{locations:G,showRoute:!0,realTimeTracking:!0,style:"streets",interactive:!0,className:"h-full"}),e.jsx(X,{children:k&&e.jsx(A.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"absolute top-20 left-4 right-4 z-20",children:e.jsx(u,{className:"bg-white/95 backdrop-blur-xl shadow-2xl border-0",children:e.jsxs(g,{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center mb-1",children:[e.jsx(me,{className:"w-4 h-4 text-primary mr-1"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"ETA"})]}),e.jsx("div",{className:"text-2xl font-bold text-primary",children:_!==null?`${_}m`:"--"})]}),e.jsxs("div",{className:"text-center border-x border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-1",children:[e.jsx(de,{className:"w-4 h-4 text-blue-600 mr-1"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Distance"})]}),e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[R.toFixed(1),"km"]})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center mb-1",children:[e.jsx(F,{className:"w-4 h-4 text-green-600 mr-1"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Speed"})]}),e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[y,e.jsx("span",{className:"text-sm ml-1",children:"km/h"})]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Trip Progress"}),e.jsxs("span",{className:"text-xs font-semibold text-primary",children:[D.toFixed(0),"%"]})]}),e.jsx("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx(A.div,{className:"h-full bg-gradient-to-r from-primary to-blue-600",initial:{width:0},animate:{width:`${D}%`},transition:{duration:.5}})})]})]})})})}),(f||v)&&e.jsx(A.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},className:"absolute bottom-24 left-4 z-20",children:e.jsx(u,{className:"bg-white/95 backdrop-blur-xl shadow-lg border-0",children:e.jsxs(g,{className:"p-3 flex items-center gap-3",children:[e.jsx(ie,{className:"w-10 h-10 border-2 border-primary",children:e.jsx(ne,{className:"bg-primary text-white",children:t?e.jsx(xe,{className:"w-5 h-5"}):e.jsx(F,{className:"w-5 h-5"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold text-sm",children:t?"Passenger Location":"Driver Location"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t?"Tracking enabled":"En route to pickup"})]}),e.jsx(N,{variant:t?"default":"secondary",className:"text-xs",children:"Live"})]})})})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 p-4",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-2 max-w-2xl mx-auto",children:[w&&e.jsxs(x,{variant:d?"default":"outline",size:"sm",onClick:H,className:"flex flex-col items-center gap-1 h-auto py-3",children:[e.jsx(he,{className:`w-5 h-5 ${d?"animate-pulse":""}`}),e.jsx("span",{className:"text-xs",children:d?"Sharing":"Share"})]}),e.jsxs(x,{variant:"outline",size:"sm",onClick:Y,className:"flex flex-col items-center gap-1 h-auto py-3",children:[e.jsx(pe,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs",children:"Share"})]}),e.jsxs(x,{variant:"outline",size:"sm",className:"flex flex-col items-center gap-1 h-auto py-3",children:[e.jsx(ue,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs",children:"Call"})]}),e.jsxs(x,{variant:"destructive",size:"sm",onClick:V,className:"flex flex-col items-center gap-1 h-auto py-3 bg-red-600 hover:bg-red-700",children:[e.jsx(ge,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs",children:"SOS"})]})]}),e.jsx("div",{className:"text-center mt-3",children:e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Last updated: ",new Date(C.current).toLocaleTimeString()]})})]})]})}function W(n,l,t,w){const m=P(t-n),c=P(w-l),p=Math.sin(m/2)*Math.sin(m/2)+Math.cos(P(n))*Math.cos(P(t))*Math.sin(c/2)*Math.sin(c/2);return 6371*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))}function ye(n){let l=0;for(let t=0;t<n.length-1;t++)l+=W(n[t].lat,n[t].lng,n[t+1].lat,n[t+1].lng);return l}function P(n){return n*(Math.PI/180)}function He(){const{user:n}=Z(),[l,t]=r.useState(null),[w,j]=r.useState(!1),{bookings:m,loading:c}=je(),{trips:p,loading:f}=oe({driverId:n?.id}),[T,v]=r.useState([]),[S,_]=r.useState([]),[L,R]=r.useState([]);r.useEffect(()=>{const a=(m||[]).filter(s=>s.status==="pending"||s.status==="accepted").map(s=>({id:s.trip_id||s.id,type:s.trip?.trip_type||"wasel",status:s.status==="accepted"?"Confirmed":"Pending",from:s.trip?.from||"Unknown",to:s.trip?.to||"Unknown",date:s.trip?.departure_date||new Date().toISOString().split("T")[0],time:s.trip?.departure_time||"12:00",seats:s.seats_requested||1,totalPrice:s.total_price||0,driver:{name:s.trip?.driver_name||"Driver",initials:(s.trip?.driver_name||"D").split(" ").map(k=>k[0]).join(""),vehicle:s.trip?.vehicle?.model||"Vehicle"}}));v(a);const b=(p||[]).filter(s=>s.status==="published"||s.status==="in_progress").map(s=>{const $=(m||[]).filter(h=>h.trip_id===s.id).map(h=>({name:h.passenger_name||"Passenger",initials:(h.passenger_name||"P").split(" ").map(C=>C[0]).join(""),seats:h.seats_requested||1}));return{id:s.id,type:s.trip_type||"wasel",from:s.from,to:s.to,date:s.departure_date,time:s.departure_time,totalSeats:s.total_seats,booked:s.total_seats-s.available_seats,pricePerSeat:s.price_per_seat,earnings:(s.total_seats-s.available_seats)*s.price_per_seat,passengers:$}});_(b);const D=[...(m||[]).filter(s=>s.status==="completed"),...(p||[]).filter(s=>s.status==="completed")].map(s=>({id:s.id||s.trip_id,type:s.trip_type||s.trip?.trip_type||"wasel",from:s.from||s.trip?.from||"Unknown",to:s.to||s.trip?.to||"Unknown",date:s.departure_date||s.trip?.departure_date||new Date().toISOString().split("T")[0],price:s.total_price||s.price_per_seat||0}));R(D)},[m,p]);const z=a=>{t(a),j(!0)},y=a=>{console.log("Location shared:",a)};return e.jsxs("div",{className:"max-w-7xl mx-auto space-y-8",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"My Trips"}),e.jsx("p",{className:"text-gray-600",children:"Manage your upcoming and past journeys"})]}),e.jsxs(ee,{defaultValue:"upcoming",className:"space-y-6",children:[e.jsxs(se,{children:[e.jsx(E,{value:"upcoming",children:"Upcoming"}),e.jsx(E,{value:"as-driver",children:"As Driver"}),e.jsx(E,{value:"completed",children:"Completed"})]}),e.jsx(U,{value:"upcoming",className:"space-y-4",children:c?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):T.length===0?e.jsx(u,{children:e.jsx(g,{className:"py-12 text-center text-muted-foreground",children:e.jsx("p",{children:"No upcoming trips. Book a ride to get started!"})})}):T.map(a=>e.jsx(u,{children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[e.jsxs("div",{className:"flex-1 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:a.type==="wasel"?"default":"secondary",children:a.type==="wasel"?"Wasel (واصل)":"Raje3 (راجع)"}),e.jsx(N,{variant:"outline",children:a.status})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(B,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:a.from}),e.jsx(I,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"font-medium",children:a.to})]})]}),e.jsxs("div",{className:"flex items-center gap-6 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4"}),e.jsx("span",{children:a.date})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"w-4 h-4"}),e.jsxs("span",{children:[a.seats," seats booked"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-3 border-t",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-sm",children:a.driver.initials})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:a.driver.name}),e.jsx("p",{className:"text-sm text-gray-500",children:a.driver.vehicle})]})]})]}),e.jsxs("div",{className:"flex lg:flex-col items-end justify-between lg:justify-start gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl text-primary",children:["$",a.totalPrice]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Total price"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>z(a),className:"gap-1",children:[e.jsx(Ne,{className:"w-3 h-3"}),"Track Live"]}),e.jsx(x,{variant:"outline",size:"sm",children:"Contact Driver"}),e.jsx(x,{variant:"outline",size:"sm",className:"text-red-600 hover:text-red-700",children:"Cancel"})]})]})]})})},a.id))}),e.jsx(U,{value:"as-driver",className:"space-y-4",children:f?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):S.length===0?e.jsx(u,{children:e.jsx(g,{className:"py-12 text-center text-muted-foreground",children:e.jsx("p",{children:"You haven't offered any rides yet. Share a ride to get started!"})})}):S.map(a=>e.jsx(u,{children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[e.jsxs("div",{className:"flex-1 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:a.type==="wasel"?"default":"secondary",children:a.type==="wasel"?"Wasel (واصل)":"Raje3 (راجع)"}),e.jsxs(N,{variant:"outline",children:[a.booked,"/",a.totalSeats," seats booked"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(B,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:a.from}),e.jsx(I,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"font-medium",children:a.to})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(q,{className:"w-4 h-4"}),e.jsxs("span",{children:[a.date," at ",a.time]})]}),a.passengers&&a.passengers.length>0&&e.jsxs("div",{className:"pt-3 border-t",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Passengers:"}),e.jsx("div",{className:"space-y-2",children:a.passengers.map((d,b)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-xs",children:d.initials})}),e.jsx("span",{children:d.name}),e.jsxs("span",{className:"text-gray-500",children:["• ",d.seats," seat(s)"]})]},b))})]})]}),e.jsxs("div",{className:"flex lg:flex-col items-end justify-between lg:justify-start gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl text-primary",children:["AED ",a.earnings]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Est. earnings"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",children:"Edit"}),e.jsx(x,{variant:"outline",size:"sm",className:"text-red-600 hover:text-red-700",children:"Cancel Trip"})]})]})]})})},a.id))}),e.jsx(U,{value:"completed",className:"space-y-4",children:L.length===0?e.jsx(u,{children:e.jsx(g,{className:"py-12 text-center text-muted-foreground",children:e.jsx("p",{children:"No completed trips yet."})})}):L.map(a=>e.jsx(u,{className:"opacity-75",children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200",children:"Completed"}),e.jsx(N,{variant:a.type==="wasel"?"default":"secondary",children:a.type==="wasel"?"Wasel":"Raje3"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(B,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:a.from}),e.jsx(I,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"font-medium",children:a.to})]})]}),e.jsx("p",{className:"text-sm text-gray-600",children:a.date})]}),e.jsxs("div",{className:"flex lg:flex-col items-end justify-between lg:justify-start gap-4",children:[e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"text-2xl",children:["$",a.price]})}),e.jsx(x,{variant:"outline",size:"sm",children:"Rate Driver"})]})]})})},a.id))})]}),l&&e.jsx(ae,{open:w,onOpenChange:j,children:e.jsxs(te,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(re,{children:e.jsx(le,{children:"Live Trip Tracking"})}),e.jsx(ve,{tripId:l.id.toString(),route:l.route||[],isDriver:!1,allowLocationSharing:!0,onShareLocation:y})]})})]})}export{He as MyTrips};
