import{r as n,j as e}from"./vendor-ui-jVyU-rC5.js";import{C as v,a as W,b as q,f as N,e as y,B as g,u as O,h as I,i as A}from"./index-DyAvE2yn.js";import{T as $,a as F,b as D,c as B}from"./tabs-DMlsRxVi.js";import{D as H,a as V,b as Y,c as G}from"./dialog-BDXIbl4w.js";import{M as J}from"./MapComponent-W-VMxfMP.js";import{A as K,O as Q,a as X}from"./alert-BrttPPBN.js";import{R as P}from"./radar-C4Jwe47A.js";import{L}from"./locate-DM14SJBn.js";import{S as Z}from"./share-2-Z_7cU2iQ.js";import{u as ee}from"./useTrips-BZOsvcTG.js";import{d as M}from"./mockDataService-CJlUMX2z.js";import{M as C}from"./move-right-BqwhuyDP.js";import{U as se}from"./users-round-Dx08XuI4.js";import"./vendor-react-7PqXWhc5.js";import"./vendor-utils-CADQ8aCF.js";import"./vendor-supabase-b92lme3K.js";import"./vendor-animation-BozBRtxF.js";function ae({tripId:u,route:i,isDriver:w=!1,allowLocationSharing:S=!0,onShareLocation:j}){const[o,b]=n.useState(null),[d,x]=n.useState(!1),[f,p]=n.useState(null),[h,_]=n.useState(null),T=()=>{if(!navigator.geolocation){p("Geolocation is not supported by your browser");return}p(null);const l={enableHighAccuracy:!0,timeout:5e3,maximumAge:0},s=navigator.geolocation.watchPosition(c=>{const m={lat:c.coords.latitude,lng:c.coords.longitude};b(m),x(!0),j&&j(m)},c=>{let m="Unable to retrieve your location";switch(c.code){case c.PERMISSION_DENIED:m="Location permission denied. Please enable location access in your browser settings.";break;case c.POSITION_UNAVAILABLE:m="Location information unavailable";break;case c.TIMEOUT:m="Location request timed out";break}p(m),x(!1)},l);_(s)},t=()=>{h!==null&&(navigator.geolocation.clearWatch(h),_(null)),x(!1),b(null)};n.useEffect(()=>()=>{h!==null&&navigator.geolocation.clearWatch(h)},[h]);const r=i.map((l,s)=>({...l,type:s===0?"start":s===i.length-1?"destination":"stop"}));return o&&d&&r.push({lat:o.lat,lng:o.lng,label:w?"Your Location (Driver)":"Your Location",type:"current"}),e.jsxs(v,{children:[e.jsx(W,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5 text-primary"}),"Live Trip Map"]}),d&&e.jsxs(N,{variant:"default",className:"bg-primary",children:[e.jsx(L,{className:"w-3 h-3 mr-1"}),"Tracking Active"]})]})}),e.jsxs(y,{className:"space-y-4",children:[f&&e.jsxs(K,{variant:"destructive",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(X,{children:f})]}),S&&e.jsxs("div",{className:"flex gap-2",children:[d?e.jsx(g,{onClick:t,variant:"outline",className:"border-destructive text-destructive hover:bg-destructive/10",children:"Stop Sharing"}):e.jsxs(g,{onClick:T,className:"bg-primary hover:bg-primary/90 text-primary-foreground",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Share My Location"]}),d&&e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-primary/5 text-primary rounded-lg",children:[e.jsx("div",{className:"w-2 h-2 bg-primary rounded-full animate-pulse"}),e.jsxs("span",{className:"text-sm",children:["Location shared with ",w?"passengers":"driver"]})]})]}),e.jsx(J,{locations:r,showRoute:!0,height:"500px"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-sm",children:"Route Details"}),e.jsx("div",{className:"space-y-2",children:i.map((l,s)=>e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsx("div",{className:`
                  w-6 h-6 rounded-full flex items-center justify-center text-xs
                  ${s===0?"bg-primary text-primary-foreground":s===i.length-1?"bg-accent text-accent-foreground":"bg-secondary text-secondary-foreground"}
                `,children:s===0?"A":s===i.length-1?"B":s}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:l.label}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s===0?"Starting Point":s===i.length-1?"Final Destination":`Stop ${s}`})]})]},s))})]})]})]})}function te(u){const{user:i}=O(),[w,S]=n.useState([]),[j,o]=n.useState(!0),[b,d]=n.useState(null);n.useEffect(()=>{i&&x()},[i,JSON.stringify(u)]);const x=async()=>{if(i)try{o(!0);let t=[];if(!u?.tripId)try{t=(await I.getUserBookings()).bookings||[]}catch{t=(await M.getUserBookings(i.id)).bookings||[]}u?.status&&u.status.length>0,u?.passengerId,S(t),d(null)}catch(t){console.error("Error fetching bookings:",t),d(t.message)}finally{o(!1)}},f=async t=>{try{const r=await M.createBooking(t.trip_id,t.seats_requested||1,t.pickup_stop,t.dropoff_stop);return await x(),{data:r.booking,error:null}}catch(r){return console.error("Error creating booking:",r),{data:null,error:r.message}}},p=async(t,r)=>{if(r.status)try{const l=await I.updateBookingStatus(t,r.status);return await x(),{data:l.booking,error:null}}catch(l){return{data:null,error:l.message}}return{data:null,error:"Only status updates are supported"}};return{bookings:w,loading:j,error:b,refresh:x,createBooking:f,updateBooking:p,acceptBooking:async t=>p(t,{status:"accepted"}),rejectBooking:async(t,r)=>p(t,{status:"rejected"}),cancelBooking:async(t,r)=>p(t,{status:"cancelled"})}}function ye(){const{user:u}=O(),[i,w]=n.useState(null),[S,j]=n.useState(!1),{bookings:o,loading:b}=te(),{trips:d,loading:x}=ee({driverId:u?.id}),[f,p]=n.useState([]),[h,_]=n.useState([]),[T,t]=n.useState([]);n.useEffect(()=>{const s=(o||[]).filter(a=>a.status==="pending"||a.status==="accepted").map(a=>({id:a.trip_id||a.id,type:a.trip?.trip_type||"wasel",status:a.status==="accepted"?"Confirmed":"Pending",from:a.trip?.from||"Unknown",to:a.trip?.to||"Unknown",date:a.trip?.departure_date||new Date().toISOString().split("T")[0],time:a.trip?.departure_time||"12:00",seats:a.seats_requested||1,totalPrice:a.total_price||0,driver:{name:a.trip?.driver_name||"Driver",initials:(a.trip?.driver_name||"D").split(" ").map(E=>E[0]).join(""),vehicle:a.trip?.vehicle?.model||"Vehicle"}}));p(s);const m=(d||[]).filter(a=>a.status==="published"||a.status==="in_progress").map(a=>{const R=(o||[]).filter(k=>k.trip_id===a.id).map(k=>({name:k.passenger_name||"Passenger",initials:(k.passenger_name||"P").split(" ").map(z=>z[0]).join(""),seats:k.seats_requested||1}));return{id:a.id,type:a.trip_type||"wasel",from:a.from,to:a.to,date:a.departure_date,time:a.departure_time,totalSeats:a.total_seats,booked:a.total_seats-a.available_seats,pricePerSeat:a.price_per_seat,earnings:(a.total_seats-a.available_seats)*a.price_per_seat,passengers:R}});_(m);const U=[...(o||[]).filter(a=>a.status==="completed"),...(d||[]).filter(a=>a.status==="completed")].map(a=>({id:a.id||a.trip_id,type:a.trip_type||a.trip?.trip_type||"wasel",from:a.from||a.trip?.from||"Unknown",to:a.to||a.trip?.to||"Unknown",date:a.departure_date||a.trip?.departure_date||new Date().toISOString().split("T")[0],price:a.total_price||a.price_per_seat||0}));t(U)},[o,d]);const r=s=>{w(s),j(!0)},l=s=>{console.log("Location shared:",s)};return e.jsxs("div",{className:"max-w-7xl mx-auto space-y-8",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"My Trips"}),e.jsx("p",{className:"text-gray-600",children:"Manage your upcoming and past journeys"})]}),e.jsxs($,{defaultValue:"upcoming",className:"space-y-6",children:[e.jsxs(F,{children:[e.jsx(D,{value:"upcoming",children:"Upcoming"}),e.jsx(D,{value:"as-driver",children:"As Driver"}),e.jsx(D,{value:"completed",children:"Completed"})]}),e.jsx(B,{value:"upcoming",className:"space-y-4",children:b?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):f.length===0?e.jsx(v,{children:e.jsx(y,{className:"py-12 text-center text-muted-foreground",children:e.jsx("p",{children:"No upcoming trips. Book a ride to get started!"})})}):f.map(s=>e.jsx(v,{children:e.jsx(y,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[e.jsxs("div",{className:"flex-1 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:s.type==="wasel"?"default":"secondary",children:s.type==="wasel"?"Wasel (واصل)":"Raje3 (راجع)"}),e.jsx(N,{variant:"outline",children:s.status})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(L,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:s.from}),e.jsx(C,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"font-medium",children:s.to})]})]}),e.jsxs("div",{className:"flex items-center gap-6 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4"}),e.jsx("span",{children:s.date})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.seats," seats booked"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-3 border-t",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-sm",children:s.driver.initials})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:s.driver.name}),e.jsx("p",{className:"text-sm text-gray-500",children:s.driver.vehicle})]})]})]}),e.jsxs("div",{className:"flex lg:flex-col items-end justify-between lg:justify-start gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl text-primary",children:["$",s.totalPrice]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Total price"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>r(s),className:"gap-1",children:[e.jsx(P,{className:"w-3 h-3"}),"Track Live"]}),e.jsx(g,{variant:"outline",size:"sm",children:"Contact Driver"}),e.jsx(g,{variant:"outline",size:"sm",className:"text-red-600 hover:text-red-700",children:"Cancel"})]})]})]})})},s.id))}),e.jsx(B,{value:"as-driver",className:"space-y-4",children:x?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):h.length===0?e.jsx(v,{children:e.jsx(y,{className:"py-12 text-center text-muted-foreground",children:e.jsx("p",{children:"You haven't offered any rides yet. Share a ride to get started!"})})}):h.map(s=>e.jsx(v,{children:e.jsx(y,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[e.jsxs("div",{className:"flex-1 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:s.type==="wasel"?"default":"secondary",children:s.type==="wasel"?"Wasel (واصل)":"Raje3 (راجع)"}),e.jsxs(N,{variant:"outline",children:[s.booked,"/",s.totalSeats," seats booked"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(L,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:s.from}),e.jsx(C,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"font-medium",children:s.to})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(A,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.date," at ",s.time]})]}),s.passengers&&s.passengers.length>0&&e.jsxs("div",{className:"pt-3 border-t",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Passengers:"}),e.jsx("div",{className:"space-y-2",children:s.passengers.map((c,m)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-xs",children:c.initials})}),e.jsx("span",{children:c.name}),e.jsxs("span",{className:"text-gray-500",children:["• ",c.seats," seat(s)"]})]},m))})]})]}),e.jsxs("div",{className:"flex lg:flex-col items-end justify-between lg:justify-start gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl text-primary",children:["AED ",s.earnings]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Est. earnings"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{variant:"outline",size:"sm",children:"Edit"}),e.jsx(g,{variant:"outline",size:"sm",className:"text-red-600 hover:text-red-700",children:"Cancel Trip"})]})]})]})})},s.id))}),e.jsx(B,{value:"completed",className:"space-y-4",children:T.length===0?e.jsx(v,{children:e.jsx(y,{className:"py-12 text-center text-muted-foreground",children:e.jsx("p",{children:"No completed trips yet."})})}):T.map(s=>e.jsx(v,{className:"opacity-75",children:e.jsx(y,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200",children:"Completed"}),e.jsx(N,{variant:s.type==="wasel"?"default":"secondary",children:s.type==="wasel"?"Wasel":"Raje3"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(L,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:s.from}),e.jsx(C,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"font-medium",children:s.to})]})]}),e.jsx("p",{className:"text-sm text-gray-600",children:s.date})]}),e.jsxs("div",{className:"flex lg:flex-col items-end justify-between lg:justify-start gap-4",children:[e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"text-2xl",children:["$",s.price]})}),e.jsx(g,{variant:"outline",size:"sm",children:"Rate Driver"})]})]})})},s.id))})]}),i&&e.jsx(H,{open:S,onOpenChange:j,children:e.jsxs(V,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Y,{children:e.jsx(G,{children:"Live Trip Tracking"})}),e.jsx(ae,{tripId:i.id.toString(),route:i.route||[],isDriver:!1,allowLocationSharing:!0,onShareLocation:l})]})})]})}export{ye as MyTrips};
