import{r as u}from"./vendor-ui-S1-b02vM.js";import{u as w,y as s}from"./index-C4myuZdd.js";function B(i){const{user:o}=w(),[g,d]=u.useState([]),[f,p]=u.useState(!0),[h,_]=u.useState(null);u.useEffect(()=>{o&&c()},[o,JSON.stringify(i)]);const c=async()=>{if(o)try{p(!0),_(null);let e=s.from("bookings").select(`
          *,
          trip:trip_id(
            *,
            driver:driver_id(id, full_name, phone_number, rating)
          ),
          passenger:passenger_id(id, full_name, phone_number)
        `);i?.tripId||i?.passengerId||(e=e.eq("passenger_id",o.id)),i?.status&&i.status.length>0;const{data:r,error:t}=await e.order("created_at",{ascending:!1});if(t)throw t;d(r||[])}catch(e){console.error("Error fetching bookings:",e),_(e.message),d([])}finally{p(!1)}},m=async e=>{if(!o)return{data:null,error:"User not authenticated"};try{const{data:r,error:t}=await s.from("trips").select("price_per_seat, available_seats").eq("id",e.trip_id).single();if(t)throw t;if(r.available_seats<e.seats_requested)throw new Error("Not enough available seats");const{data:a,error:n}=await s.from("bookings").insert({trip_id:e.trip_id,passenger_id:o.id,seats_requested:e.seats_requested,pickup_stop:e.pickup_stop,dropoff_stop:e.dropoff_stop,total_price:r.price_per_seat*e.seats_requested,status:"pending",created_at:new Date().toISOString()}).select().single();if(n)throw n;return await s.from("trips").update({available_seats:r.available_seats-e.seats_requested}).eq("id",e.trip_id),await c(),{data:a,error:null}}catch(r){return console.error("Error creating booking:",r),{data:null,error:r.message}}},l=async(e,r)=>{try{const{data:t,error:a}=await s.from("bookings").update({...r,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw a;return await c(),{data:t,error:null}}catch(t){return console.error("Error updating booking:",t),{data:null,error:t.message}}};return{bookings:g,loading:f,error:h,refresh:c,createBooking:m,updateBooking:l,acceptBooking:async e=>l(e,{status:"accepted"}),rejectBooking:async e=>l(e,{status:"rejected"}),cancelBooking:async e=>{try{const{data:r,error:t}=await s.from("bookings").select("trip_id, seats_requested").eq("id",e).single();if(t)throw t;const a=await l(e,{status:"cancelled"});if(a.error===null){const{data:n}=await s.from("trips").select("available_seats").eq("id",r.trip_id).single();n&&await s.from("trips").update({available_seats:n.available_seats+r.seats_requested}).eq("id",r.trip_id)}return a}catch(r){return console.error("Error cancelling booking:",r),{data:null,error:r.message}}}}}export{B as u};
